<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../iron-pages/iron-pages.html">

<dom-module id="glor-auth-login">
    <template>
        <style>
            :host {
                display: block;
                margin: 0;
                padding: 0;
            }
            
            paper-tabs {
                color: white;
                background-color: var(--glor-auth-login-tab-background-color, olive);
                --paper-tabs-selection-bar-color: coral;
            }

            .section {
                padding: 20px;
                background-color: var(--glor-auth-login-content, beige);
                @apply --glor-auth-login-content;
            }

            paper-button {
                color: var(--glor-auth-login-button-foreground-color, white);
                background-color: var(--glor-auth-login-button-background-color, coral);
            }
        </style>
        <iron-ajax
            id="registerRequest"
            url="http://localhost:65336/Api/Account/Register"
            method="POST"
            body="{{registerRequestBody}}"
            content-type="application/json"
            on-response="_registerResponse"
            on-error="_registerError">
        </iron-ajax>
        <iron-ajax
            id="loginRequest"
            url="http://localhost:65336/Token"
            method="POST"
            body="{{loginRequestBody}}"
            content-type="application/x-www-form-urlencoded"
            handle-as="json"
            last-response="{{tokenInfo}}"
            on-response="_loginResponse"
            on-error="_loginError">
        </iron-ajax>

        <paper-tabs selected="{{selected}}">
            <paper-tab>
                LOGIN
            </paper-tab>
            <paper-tab>
                REGISTER
            </paper-tab>
        </paper-tabs>

        <iron-pages selected="{{selected}}">
            <div class="section">
                <paper-input label="Email" value="{{email}}"></paper-input>
                <paper-input label="Password" value="{{password}}" type="password"></paper-input>
                <paper-button on-tap="_login">Login</paper-button>
                <div>
                    <span>{{message}}</span>
                </div>
            </div>
            <div class="section">
                <paper-input label="Email" value="{{email}}"></paper-input>
                <paper-input label="Password" value="{{password}}" type="password"></paper-input>
                <paper-input label="Confirm Password" value="{{password}}" type="password"></paper-input>
                <paper-button on-tap="_register">Register</paper-button>
                <div>
                    <span>{{message}}</span>
                </div>
            </div>
        </iron-pages>
    </template>

    <script>
        /**
        * `glor-auth-login`
        * A Polymer element that handles user authentication to an ASP.NET WebApi 2 service that is using Microsoft Identity as the backing user store and token server.
        *
        * @customElement
        * @polymer
        * @demo demo/index.html
        */
        class GlorAuthLogin extends Polymer.Element {
            static get is() { return 'glor-auth-login'; }
            static get properties() {
                return {
                    selected: {
                        type: Number,
                        notify: true,
                        value: 0
                    },
                    email: {
                        type: String,
                        value: 'test@test.com'
                    },
                    password: {
                        type: String,
                        value: 'Test0!'
                    },
                    newPassword: {
                        type: String
                    },
                    registerRequestBody: {
                        type: Object,
                        computed: '_computeRegisterRequestBody(email, password)'
                    },
                    loginRequestBody: {
                        type: Object,
                        computed: '_computeLoginRequestBody(email, password)'
                    },
                    message: {
                        type: String
                    },
                    tokenInfo: {
                        type: Object
                    },
                    userInfo: {
                        type: Object
                    }
                };
            }
            
            _register() {
                this.$.registerRequest.generateRequest();
            }
            
            _registerResponse(event) {
                this.message = event.response;
            }
            
            _registerError(event) {
                this.message = event.detail.error.message + " " + event.detail.request.response.message + " " + event.detail.request.response.ModelState["model.Password"];
            }

            _computeRegisterRequestBody(email, password) {
                return {
                    "Email": email,
                    "Password": password,
                    "ConfirmPassword": password
                };
            }

            _login() {
                this.$.loginRequest.generateRequest();
            }

            _loginResponse(event) {

            }

            _loginError(event) {
                this.message = event.detail.error.message + " " + event.detail.request.response.message + " " + event.detail.request.response.ModelState["model.Password"];
            }

            _computeLoginRequestBody(email, password) {
                return {
                    "username": email,
                    "password": password,
                    "grant_type": "password"
                };
            }
        }

        window.customElements.define(GlorAuthLogin.is, GlorAuthLogin);
    </script>
</dom-module>
